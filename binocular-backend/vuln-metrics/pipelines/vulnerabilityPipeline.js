import { persistVersionChanges } from './persistVersionChanges.js';
import { enrichVersionChanges } from './enrichVersionChanges.js';
import { computeVulnerabilityAgeBucketsInterpolated } from '../services/computeVulnerabilityAgeBuckets';

export async function runVulnerabilityEnrichment(repo, currentBranch) {
  console.log('=== Vulnerability Enrichment Pipeline Started ===');

  try {
    console.log('[1/3] Persisting version change events...');
    await persistVersionChanges(repo, currentBranch);
    console.log('[1/3] Done.');

    console.log('[2/3] Enriching version change events with vulnerability data...');
    await enrichVersionChanges();
    console.log('[2/3] Done.');

    console.log('[3/3] Computing vulnerability age buckets...');
    await computeVulnerabilityAgeBucketsInterpolated(currentBranch);
    console.log('[3/3] Done.');

    console.log('=== Vulnerability Enrichment Pipeline Completed ===');
  } catch (error) {
    console.error('Vulnerability enrichment pipeline failed:', error);
  }
}
