/**
 * Retrieves and normalizes vulnerability information for one or more libraries from OSV.dev.
 * Batch-queries the OSV API
 * @param {string|string[]} libraries - Single library name or array of names.
 * @returns {Promise<Array>} Normalized vulnerability objects.
 */

export async function retrieveVulnerabilityInfo(libraries) {
  const libs = Array.isArray(libraries) ? libraries : [libraries];
  if (!libs.length) return [];

  const queries = libs.map((name) => ({
    package: { name: name.trim(), ecosystem: 'npm' },
  }));

  const res = await fetch('https://api.osv.dev/v1/querybatch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ queries }),
  });

  if (!res.ok) {
    throw new Error(`OSV API request failed (${res.status} ${res.statusText})`);
  }

  const data = await res.json();
  const results = [];

  data.results.forEach((result, idx) => {
    const library = libs[idx];
    if (!result.vulns || !Array.isArray(result.vulns)) return;

    for (const vuln of result.vulns) {
      const { id, summary, details, published, modified, severity = [], references = [], affected = [] } = vuln;

      const cvss = (severity.find((s) => s.type === 'CVSS_V3') || {}).score || null;
      const baseSeverity = cvss ? cvssToLabel(cvss) : 'UNKNOWN';

      const { affectedVersions, patchedVersions } = extractRanges(affected);

      results.push({
        vulnId: id,
        cve: id,
        severity: baseSeverity,
        cvssScore: cvss,
        cvssVector: null,
        advisoryUrl: references[0]?.url || '',
        title: summary?.slice(0, 140) || '',
        description: details || '',
        affectedVersions,
        patchedVersions,
        publishedAt: published || null,
        lastModifiedAt: modified || null,
        library,
      });
    }
  });

  return results;
}

/**
 * Extract affected and patched version ranges from OSV "affected" array.
 */
function extractRanges(affected = []) {
  const affectedSet = new Set();
  const patchedSet = new Set();

  for (const a of affected) {
    for (const range of a.ranges || []) {
      if (range.type !== 'SEMVER') continue;
      for (const event of range.events || []) {
        if (event.introduced && event.introduced !== '0') {
          affectedSet.add(`>=${event.introduced}`);
        }
        if (event.fixed) {
          affectedSet.add(`<${event.fixed}`);
          patchedSet.add(`>=${event.fixed}`);
        }
      }
    }
  }

  return {
    affectedVersions: affectedSet.size ? [...affectedSet] : null,
    patchedVersions: patchedSet.size ? [...patchedSet] : null,
  };
}

/**
 * Convert numeric CVSS score to qualitative severity.
 */
function cvssToLabel(score) {
  if (score >= 9.0) return 'CRITICAL';
  if (score >= 7.0) return 'HIGH';
  if (score >= 4.0) return 'MEDIUM';
  if (score >= 0.1) return 'LOW';
  return 'NONE';
}
