'use strict';

import { aql } from 'arangojs';
import Connection from './Connection.js';
import VersionChangeEvent from './VersionChangeEvent.js';
import Vulnerability from './Vulnerability.js';

const VersionChangeEventVulnerabilityConnection = Connection.define(Vulnerability, VersionChangeEvent, {
  attributes: ['library', 'libraryVersion', 'affectedVersions', 'patchedVersions', 'matchReason'],
});

VersionChangeEventVulnerabilityConnection.findByEvent = async function (eventKey) {
  const fromCollectionName = VersionChangeEvent.collection.name || VersionChangeEvent.collectionName;

  const cursor = await this.db.arango.query(aql`
    FOR edge IN ${VersionChangeEventVulnerabilityConnection.collection}
      FILTER edge._from == CONCAT(${fromCollectionName}, "/", ${eventKey})
      RETURN edge
  `);

  return cursor.all();
};

export default VersionChangeEventVulnerabilityConnection;
