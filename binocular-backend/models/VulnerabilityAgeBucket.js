'use strict';

import _ from 'lodash';
import Model from './Model.js';
import IllegalArgumentError from '../errors/IllegalArgumentError.js';

const VulnerabilityAgeBucket = Model.define('VulnerabilityAgeBucket', {
  attributes: ['id', 'branch', 'date', 'buckets', 'createdAt'],
  keyAttribute: 'id',
});

VulnerabilityAgeBucket.persist = function (_data) {
  const data = _.clone(_data);

  if (!data.branch || !data.date) {
    throw new IllegalArgumentError('VulnerabilityAgeBucket requires branch and date!');
  }

  data.id = `${data.branch.replace(/\//g, '-')}-${new Date(data.date).toISOString()}`;
  data.createdAt = data.createdAt || new Date().toISOString();

  return VulnerabilityAgeBucket.ensureById(data.id, data, {
    ignoreUnknownAttributes: true,
  });
};

export default VulnerabilityAgeBucket;
